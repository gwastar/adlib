#include <assert.h>
#include <limits.h>
#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include "dstring.h"
#include "testing.h"

#ifdef HAVE_MALLOC_USABLE_SIZE
#include <malloc.h>
#endif

static bool sanity_check(const dstr_t dstr)
{
	CHECK(dstr_length(dstr) <= dstr_capacity(dstr));
	CHECK(strlen(dstr) == dstr_length(dstr));
#ifdef HAVE_MALLOC_USABLE_SIZE
	CHECK(malloc_usable_size(_dstr_debug_get_head_ptr(dstr)) >= dstr_capacity(dstr));
#endif
	return true;
}

static int sign(int x)
{
	return x < 0 ? -1 : (x > 0 ? 1 : 0);
}

SIMPLE_TEST(dstring)
{
	const char *abc = "abcdefghijklmnopqrstuvwxyz";
	const char *a256 = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789`~!@#$%^&*()-=_+[]\\;',./{}|:\"<>?abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789`~!@#$%^&*()-=_+[]\\;',./{}|:\"<>?abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789`~!@#$";
	size_t abc_len = strlen(abc);
	size_t a256_len = strlen(a256);
	CHECK(abc_len == 26);
	CHECK(a256_len == 256);

	dstr_t dstr = dstr_from_cstr("abc");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "def");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "ghi");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "jkl");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "mno");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "pqr");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "stu");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "vwx");
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "yz");
	CHECK(sanity_check(dstr));
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr_free(&dstr);
	CHECK(!dstr);

	dstr = dstr_new();
	for (size_t n = 0; n < 100; n++) {
		for (size_t i = 0; i < 26; i++) {
			char c = 'a' + i;
			dstr_append_char(&dstr, c);
		}
		CHECK(sanity_check(dstr));
	}

	for (size_t n = 0; n < 100; n++) {
		dstr_t d = dstr_substring_copy(dstr, n * 26, 26);
		CHECK(sanity_check(d));
		CHECK(dstr_equal_cstr(d, abc));
		dstr_free(&d);
	}

	CHECK(dstr_find_cstr(dstr, "abc", 0) == 0);
	CHECK(dstr_find_cstr(dstr, "def", 0) == 3);
	CHECK(dstr_rfind_cstr(dstr, "xyz", DSTR_NPOS) == 2597);
	CHECK(dstr_rfind_cstr(dstr, "uvw", DSTR_NPOS) == 2594);
	dstr_free(&dstr);

	dstr = dstr_new();
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_with_capacity(0);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_with_capacity(123);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) >= 123);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_chars(abc, abc_len);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_chars(a256, a256_len);
	CHECK(dstr_length(dstr) == a256_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	CHECK(dstr_length(dstr) == a256_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_view(strview_from_cstr(abc));
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_view(strview_from_cstr(a256));
	CHECK(dstr_length(dstr) == a256_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%u", 123);
	CHECK(dstr_length(dstr) == 3);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%s", abc);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%s", a256);
	CHECK(dstr_length(dstr) == a256_len);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_resize(&dstr, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 123);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) >= 123);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 1234);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) >= 1234);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	dstr_resize(&dstr, abc_len / 2);
	CHECK(dstr_equal_view(dstr, strview_from_chars(abc, abc_len / 2)));
	CHECK(sanity_check(dstr));
	dstr_clear(&dstr);
	dstr_append_cstr(&dstr, a256);
	dstr_resize(&dstr, a256_len / 2);
	CHECK(dstr_equal_view(dstr, strview_from_chars(a256, a256_len / 2)));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_cstr(&dstr, abc);
	dstr_resize(&dstr, abc_len);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT8_MAX + 1);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(strcmp(dstr + abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT16_MAX + 1);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(strcmp(dstr + abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT16_MAX - 1);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT8_MAX - 1);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT16_MAX + 1);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT8_MAX - 1);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT8_MAX + 1);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT16_MAX + 1);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT8_MAX + 1);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, UINT16_MAX + 1);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_resize(&dstr, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_reserve(&dstr, abc_len);
	CHECK(dstr_capacity(dstr) - dstr_length(dstr) >= abc_len);
	CHECK(sanity_check(dstr));
	dstr_reserve(&dstr, abc_len);
	CHECK(dstr_capacity(dstr) - dstr_length(dstr) >= abc_len);
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(sanity_check(dstr));
	dstr_reserve(&dstr, abc_len);
	CHECK(dstr_capacity(dstr) - dstr_length(dstr) >= abc_len);
	CHECK(dstr_capacity(dstr) >= 2 * abc_len);
	CHECK(sanity_check(dstr));
	dstr_shrink_to_fit(&dstr);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(dstr_capacity(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_clear(&dstr);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_clear(&dstr);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_shrink_to_fit(&dstr);
	CHECK(dstr_capacity(dstr) == 0);
	CHECK(sanity_check(dstr));
	dstr_clear(&dstr);
	CHECK(dstr_is_empty(dstr));
	CHECK(dstr_capacity(dstr) == 0);
	CHECK(sanity_check(dstr));
	dstr_shrink_to_fit(&dstr);
	CHECK(dstr_capacity(dstr) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_t dstr2 = dstr_copy(dstr);
	CHECK(dstr_is_empty(dstr2));
	CHECK(sanity_check(dstr2));
	dstr_append_cstr(&dstr2, abc);
	dstr_free(&dstr);
	dstr = dstr_copy(dstr2);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(strcmp(dstr, abc) == 0);
	CHECK(sanity_check(dstr));
	for (size_t i = 0; i < 99; i++) {
		dstr_append_cstr(&dstr, abc);
	}
	dstr_free(&dstr2);
	dstr2 = dstr_copy(dstr);
	CHECK(dstr_length(dstr2) == 100 * abc_len);
	CHECK(dstr_equal_dstr(dstr, dstr2));
	CHECK(sanity_check(dstr));
	CHECK(sanity_check(dstr2));
	dstr_free(&dstr);
	dstr_free(&dstr2);

	dstr = dstr_new();
	dstr_append_char(&dstr, 'a');
	CHECK(strcmp(dstr, "a") == 0);
	CHECK(sanity_check(dstr));
	dstr_append_char(&dstr, 'a');
	CHECK(strcmp(dstr, "aa") == 0);
	CHECK(sanity_check(dstr));
	dstr_clear(&dstr);
	for (size_t i = 0; i < 256; i++) {
		dstr_append_char(&dstr, 'a');
	}
	for (size_t i = 0; i < 256; i++) {
		CHECK(dstr[i] == 'a');
	}
	CHECK(sanity_check(dstr));
	for (size_t i = 0; i < 256; i++) {
		dstr_append_char(&dstr, 'b');
	}
	CHECK(dstr_length(dstr) == 512);
	for (size_t i = 0; i < 256; i++) {
		CHECK(dstr[i] == 'a');
	}
	for (size_t i = 0; i < 256; i++) {
		CHECK(dstr[256 + i] == 'b');
	}
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_chars(&dstr, abc, abc_len);
	CHECK(dstr_length(dstr) == abc_len);
	CHECK(sanity_check(dstr));
	dstr_append_chars(&dstr, a256, a256_len);
	CHECK(dstr_length(dstr) == abc_len + a256_len);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_cstr(&dstr, abc);
	CHECK(sanity_check(dstr));
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr_append_cstr(&dstr, a256);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_view(&dstr, strview_from_cstr(abc));
	CHECK(sanity_check(dstr));
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr_append_view(&dstr, strview_from_cstr(a256));
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_fmt(&dstr, "%s", abc);
	CHECK(sanity_check(dstr));
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr_append_fmt(&dstr, "%s", a256);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr2 = dstr_from_cstr(abc);
	dstr_append_dstr(&dstr, dstr2);
	dstr_free(&dstr2);
	CHECK(sanity_check(dstr));
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr2 = dstr_from_cstr(a256);
	dstr_append_dstr(&dstr, dstr2);
	dstr_free(&dstr2);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, abc) == 0);
	dstr_free(&dstr);

	dstr = dstr_from_view(strview_from_cstr(a256));
	CHECK(sanity_check(dstr));
	dstr_append_view(&dstr, strview_from_cstr(abc));
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, abc) == 0);
	dstr_free(&dstr);

	dstr = dstr_from_chars(a256, a256_len);
	CHECK(sanity_check(dstr));
	dstr_append_chars(&dstr, abc, abc_len);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, abc) == 0);
	dstr_free(&dstr);

	dstr2 = dstr_from_cstr(a256);
	dstr = dstr_copy(dstr2);
	dstr_free(&dstr2);
	CHECK(sanity_check(dstr));
	dstr2 = dstr_from_cstr(abc);
	dstr_append_dstr(&dstr, dstr2);
	dstr_free(&dstr2);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, abc) == 0);
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%s", a256);
	CHECK(sanity_check(dstr));
	dstr_append_fmt(&dstr, "%s", abc);
	CHECK(sanity_check(dstr));
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, abc) == 0);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_append_cstr(&dstr, "");
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "");
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, "");
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_view(strview_from_cstr(""));
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_append_view(&dstr, strview_from_cstr(""));
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_view(&dstr, strview_from_cstr(""));
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_view(&dstr, strview_from_cstr(""));
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr2 = dstr_new();
	dstr = dstr_copy(dstr2);
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_append_dstr(&dstr, dstr2);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_dstr(&dstr, dstr2);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_dstr(&dstr, dstr2);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_chars("", 0);
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_append_chars(&dstr, "", 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_chars(&dstr, "", 0);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_chars(&dstr, "", 0);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%s", "");
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_append_fmt(&dstr, "%s", "");
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_fmt(&dstr, "%s", "");
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_append_fmt(&dstr, "%s", "");
	CHECK(strncmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	char *m = dstr_append_uninitialized(&dstr, abc_len);
	strcpy(m, abc);
	CHECK(dstr_equal_cstr(dstr, abc));
	CHECK(sanity_check(dstr));
	m = dstr_append_uninitialized(&dstr, a256_len);
	strcpy(m, a256);
	CHECK(memcmp(dstr, abc, abc_len) == 0);
	CHECK(strcmp(dstr + abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	CHECK(*dstr_append_uninitialized(&dstr, 0) == '\0'); // TODO should this return NULL?
	CHECK(sanity_check(dstr));
	CHECK(*dstr_insert_uninitialized(&dstr, 0, 0) == abc[0]); // TODO should this return NULL?
	CHECK(sanity_check(dstr));
	CHECK(*dstr_insert_uninitialized(&dstr, abc_len, 0) == a256[0]); // TODO should this return NULL?
	CHECK(sanity_check(dstr));
	m = dstr_insert_uninitialized(&dstr, abc_len, abc_len);
	memcpy(m, abc, abc_len);
	CHECK(memcmp(dstr, abc, abc_len) == 0);
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len, a256) == 0);
	CHECK(sanity_check(dstr));
	m = dstr_insert_uninitialized(&dstr, 2 * abc_len, a256_len);
	memcpy(m, a256, a256_len);
	CHECK(memcmp(dstr, abc, abc_len) == 0);
	CHECK(memcmp(dstr + abc_len, abc, abc_len) == 0);
	CHECK(memcmp(dstr + 2 * abc_len, a256, a256_len) == 0);
	CHECK(strcmp(dstr + 2 * abc_len + a256_len, a256) == 0);
	CHECK(sanity_check(dstr));
	m = dstr_replace_uninitialized(&dstr, 2 * abc_len, a256_len, 0);
	CHECK(strcmp(m, a256) == 0);
	CHECK(sanity_check(dstr));
	m = dstr_replace_uninitialized(&dstr, abc_len, abc_len, a256_len);
	memcpy(m, a256, a256_len);
	CHECK(memcmp(dstr, abc, abc_len) == 0);
	CHECK(memcmp(dstr + abc_len, a256, a256_len) == 0);
	CHECK(strcmp(dstr + abc_len + a256_len, a256) == 0);
	CHECK(sanity_check(dstr));
	m = dstr_replace_uninitialized(&dstr, 0, DSTR_NPOS, abc_len);
	memcpy(m, abc, abc_len);
	CHECK(strcmp(dstr, abc) == 0);
	CHECK(sanity_check(dstr));
	dstr_replace_uninitialized(&dstr, 0, DSTR_NPOS, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_insert_cstr(&dstr, 0, "");
	dstr_insert_char(&dstr, 0, 'a');
	CHECK(strcmp(dstr, "a") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, 1, 'b');
	CHECK(strcmp(dstr, "ab") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, 0, 'c');
	CHECK(strcmp(dstr, "cab") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, 1, 'd');
	CHECK(strcmp(dstr, "cdab") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, 3, 'e');
	CHECK(strcmp(dstr, "cdaeb") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, 2, 'f');
	CHECK(strcmp(dstr, "cdfaeb") == 0);
	CHECK(sanity_check(dstr));
	dstr_insert_chars(&dstr, 0, a256, a256_len);
	CHECK(dstr_endswith_cstr(dstr, "cdfaeb"));
	CHECK(sanity_check(dstr));
	dstr_insert_char(&dstr, a256_len, 'g');
	CHECK(dstr_endswith_cstr(dstr, "gcdfaeb"));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	for (size_t i = 0; i <= abc_len; i++) {
		dstr = dstr_new();
		dstr_insert_cstr(&dstr, 0, abc);
		CHECK(sanity_check(dstr));
		dstr_insert_cstr(&dstr, i, a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strncmp(dstr + i, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i + a256_len, abc + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_view(&dstr, 0, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		dstr_insert_view(&dstr, i, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strncmp(dstr + i, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i + a256_len, abc + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_chars(&dstr, 0, abc, abc_len);
		CHECK(sanity_check(dstr));
		dstr_insert_chars(&dstr, i, a256, a256_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strncmp(dstr + i, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i + a256_len, abc + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr2 = dstr_from_cstr(abc);
		dstr_insert_dstr(&dstr, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(a256);
		dstr_insert_dstr(&dstr, i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strncmp(dstr + i, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i + a256_len, abc + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_fmt(&dstr, 0, "%s", abc);
		CHECK(sanity_check(dstr));
		dstr_insert_fmt(&dstr, i, "%s", a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strncmp(dstr + i, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i + a256_len, abc + i) == 0);
		dstr_free(&dstr);
	}

	for (size_t i = 0; i <= a256_len; i++) {
		dstr = dstr_new();
		dstr_insert_cstr(&dstr, 0, a256);
		CHECK(sanity_check(dstr));
		dstr_insert_cstr(&dstr, i, abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strncmp(dstr + i, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i + abc_len, a256 + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_view(&dstr, 0, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		dstr_insert_view(&dstr, i, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strncmp(dstr + i, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i + abc_len, a256 + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_chars(&dstr, 0, a256, a256_len);
		CHECK(sanity_check(dstr));
		dstr_insert_chars(&dstr, i, abc, abc_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strncmp(dstr + i, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i + abc_len, a256 + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr2 = dstr_from_cstr(a256);
		dstr_insert_dstr(&dstr, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(abc);
		dstr_insert_dstr(&dstr, i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strncmp(dstr + i, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i + abc_len, a256 + i) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_insert_fmt(&dstr, 0, "%s", a256);
		CHECK(sanity_check(dstr));
		dstr_insert_fmt(&dstr, i, "%s", abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strncmp(dstr + i, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
	}

	dstr = dstr_from_cstr(abc);
	for (size_t i = 0; i <= abc_len; i++) {
		dstr_insert_chars(&dstr, i, "", 0);
		dstr_insert_cstr(&dstr, i, "");
		dstr_insert_view(&dstr, i, strview_from_cstr(""));
		dstr_insert_fmt(&dstr, i, "%s", "");
		CHECK(sanity_check(dstr));
		CHECK(dstr_equal_cstr(dstr, abc));
	}
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i <= a256_len; i++) {
		dstr_insert_chars(&dstr, i, "", 0);
		dstr_insert_cstr(&dstr, i, "");
		dstr_insert_view(&dstr, i, strview_from_cstr(""));
		dstr_insert_fmt(&dstr, i, "%s", "");
		CHECK(sanity_check(dstr));
		CHECK(dstr_equal_cstr(dstr, a256));
	}
	dstr_free(&dstr);

	for (size_t i = 0; i <= abc_len; i++) {
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, abc);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, i, DSTR_NPOS, a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, a256) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, abc);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, 0, i, a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, a256_len) == 0);
		CHECK(strcmp(dstr + a256_len, abc + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, abc);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, i / 2, abc_len - i, a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i / 2 + a256_len, abc + i / 2 + (abc_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, i, DSTR_NPOS, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, a256) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, 0, i, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, a256_len) == 0);
		CHECK(strcmp(dstr + a256_len, abc + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, i / 2, abc_len - i, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i / 2 + a256_len, abc + i / 2 + (abc_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, abc, abc_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, i, DSTR_NPOS, a256, a256_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, a256) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, abc, abc_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, 0, i, a256, a256_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, a256_len) == 0);
		CHECK(strcmp(dstr + a256_len, abc + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, abc, abc_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, i / 2, abc_len - i, a256, a256_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i / 2 + a256_len, abc + i / 2 + (abc_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr2 = dstr_from_cstr(abc);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, i, DSTR_NPOS, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, a256) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr2 = dstr_from_cstr(abc);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, 0, i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, a256_len) == 0);
		CHECK(strcmp(dstr + a256_len, abc + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr2 = dstr_from_cstr(abc);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, i / 2, abc_len - i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i / 2 + a256_len, abc + i / 2 + (abc_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", abc);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, i, DSTR_NPOS, "%s", a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, a256) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", abc);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, 0, i, "%s", a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, a256_len) == 0);
		CHECK(strcmp(dstr + a256_len, abc + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", abc);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, i / 2, abc_len - i, "%s", a256);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, a256, a256_len) == 0);
		CHECK(strcmp(dstr + i / 2 + a256_len, abc + i / 2 + (abc_len - i)) == 0);
		dstr_free(&dstr);
	}

	for (size_t i = 0; i <= a256_len; i++) {
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, a256);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, i, DSTR_NPOS, abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, abc) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, a256);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, 0, i, abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, abc_len) == 0);
		CHECK(strcmp(dstr + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_cstr(&dstr, 0, 0, a256);
		CHECK(sanity_check(dstr));
		dstr_replace_cstr(&dstr, i / 2, a256_len - i, abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i / 2 + abc_len, a256 + i / 2 + (a256_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, i, DSTR_NPOS, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, abc) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, 0, i, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, abc_len) == 0);
		CHECK(strcmp(dstr + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_view(&dstr, 0, 0, strview_from_cstr(a256));
		CHECK(sanity_check(dstr));
		dstr_replace_view(&dstr, i / 2, a256_len - i, strview_from_cstr(abc));
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i / 2 + abc_len, a256 + i / 2 + (a256_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, a256, a256_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, i, DSTR_NPOS, abc, abc_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, abc) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, a256, a256_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, 0, i, abc, abc_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, abc_len) == 0);
		CHECK(strcmp(dstr + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_chars(&dstr, 0, 0, a256, a256_len);
		CHECK(sanity_check(dstr));
		dstr_replace_chars(&dstr, i / 2, a256_len - i, abc, abc_len);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i / 2 + abc_len, a256 + i / 2 + (a256_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(abc);
		dstr_replace_dstr(&dstr, i, DSTR_NPOS, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, abc) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		dstr2 = dstr_from_cstr(abc);
		dstr_replace_dstr(&dstr, 0, i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, abc_len) == 0);
		CHECK(strcmp(dstr + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr2 = dstr_from_cstr(a256);
		dstr_replace_dstr(&dstr, 0, 0, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(dstr2 = dstr_from_cstr(abc));
		dstr_replace_dstr(&dstr, i / 2, a256_len - i, dstr2);
		dstr_free(&dstr2);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i / 2 + abc_len, a256 + i / 2 + (a256_len - i)) == 0);
		dstr_free(&dstr);

		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", a256);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, i, DSTR_NPOS, "%s", abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, abc) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", a256);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, 0, i, "%s", abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, abc, abc_len) == 0);
		CHECK(strcmp(dstr + abc_len, a256 + i) == 0);
		dstr_free(&dstr);
		dstr = dstr_new();
		dstr_replace_fmt(&dstr, 0, 0, "%s", a256);
		CHECK(sanity_check(dstr));
		dstr_replace_fmt(&dstr, i / 2, a256_len - i, "%s", abc);
		CHECK(sanity_check(dstr));
		CHECK(strncmp(dstr, a256, i / 2) == 0);
		CHECK(strncmp(dstr + i / 2, abc, abc_len) == 0);
		CHECK(strcmp(dstr + i / 2 + abc_len, a256 + i / 2 + (a256_len - i)) == 0);
		dstr_free(&dstr);
	}

	dstr = dstr_from_cstr(abc);
	for (size_t i = 0; i < abc_len; i++) {
		dstr_replace_cstr(&dstr, i % dstr_length(dstr), 1, "");
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_is_empty(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < a256_len; i++) {
		dstr_replace_view(&dstr, i % dstr_length(dstr), 1, strview_from_cstr(""));
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_is_empty(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	for (size_t i = 0; i < abc_len; i++) {
		dstr_replace_chars(&dstr, i % dstr_length(dstr), 1, "", 0);
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_is_empty(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < a256_len; i++) {
		dstr_replace_fmt(&dstr, i % dstr_length(dstr), 1, "%s", "");
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_is_empty(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_replace_cstr(&dstr, 0, 0, "");
	CHECK(sanity_check(dstr));
	CHECK(dstr_is_empty(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_erase(&dstr, 0, 0);
	CHECK(sanity_check(dstr));
	dstr_append_cstr(&dstr, a256);
	dstr_append_cstr(&dstr, a256);
	CHECK(strncmp(dstr, a256, a256_len) == 0);
	CHECK(strcmp(dstr + a256_len, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, 0, a256_len / 4);
	CHECK(dstr_length(dstr) == 7 * a256_len / 4);
	CHECK(strncmp(dstr, a256 + a256_len / 4, 3 * (a256_len / 4)) == 0);
	CHECK(strcmp(dstr + 3 * (a256_len / 4), a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, dstr_length(dstr) - a256_len / 4, a256_len / 4);
	CHECK(dstr_length(dstr) == 3 * a256_len / 2);
	CHECK(strncmp(dstr, a256 + a256_len / 4, 3 * (a256_len / 4)) == 0);
	CHECK(strncmp(dstr + 3 * (a256_len / 4), a256, 3 * (a256_len / 4)) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, a256_len / 2, a256_len / 2);
	CHECK(dstr_length(dstr) == a256_len);
	CHECK(strncmp(dstr, a256 + a256_len / 4, a256_len / 2) == 0);
	CHECK(strncmp(dstr + a256_len / 2, a256 + a256_len / 4, a256_len / 2) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_cstr(&dstr, a256);
	CHECK(strcmp(dstr, a256) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, 0, a256_len / 8);
	CHECK(dstr_length(dstr) == 7 * a256_len / 8);
	CHECK(strncmp(dstr, a256 + a256_len / 8, 7 * a256_len / 8) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, dstr_length(dstr) - a256_len / 8, a256_len / 8);
	CHECK(dstr_length(dstr) == 3 * a256_len / 4);
	CHECK(strncmp(dstr, a256 + a256_len / 8, 3 * a256_len / 4) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, a256_len / 4, a256_len / 4);
	CHECK(dstr_length(dstr) == a256_len / 2);
	CHECK(strncmp(dstr, a256 + a256_len / 8, a256_len / 4) == 0);
	CHECK(strncmp(dstr + a256_len / 4, a256 + 5 * a256_len / 8, a256_len / 4) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_append_chars(&dstr, abc, 24);
	CHECK(strncmp(dstr, abc, 24) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, 0, 24 / 8);
	CHECK(dstr_length(dstr) == 7 * 24 / 8);
	CHECK(strncmp(dstr, abc + 24 / 8, 7 * 24 / 8) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, dstr_length(dstr) - 24 / 8, 24 / 8);
	CHECK(dstr_length(dstr) == 3 * 24 / 4);
	CHECK(strncmp(dstr, abc + 24 / 8, 3 * 24 / 4) == 0);
	CHECK(sanity_check(dstr));
	dstr_erase(&dstr, 24 / 4, 24 / 4);
	CHECK(dstr_length(dstr) == 24 / 2);
	CHECK(strncmp(dstr, abc + 24 / 8, 24 / 4) == 0);
	CHECK(strncmp(dstr + 24 / 4, abc + 5 * 24 / 8, 24 / 4) == 0);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	for (size_t i = 0; i + 3 <= abc_len; i++) {
		dstr = dstr_from_cstr(abc);
		dstr_erase(&dstr, i, 3);
		CHECK(dstr_length(dstr) == abc_len - 3);
		CHECK(strncmp(dstr, abc, i) == 0);
		CHECK(strcmp(dstr + i, abc + i + 3) == 0);
		CHECK(sanity_check(dstr));
		dstr_free(&dstr);
	}

	for (size_t i = 0; i + 2 <= a256_len; i++) {
		dstr = dstr_from_cstr(a256);
		dstr_erase(&dstr, i, 2);
		CHECK(dstr_length(dstr) == a256_len - 2);
		CHECK(strncmp(dstr, a256, i) == 0);
		CHECK(strcmp(dstr + i, a256 + i + 2) == 0);
		CHECK(sanity_check(dstr));
		dstr_free(&dstr);
	}

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < a256_len; i++) {
		dstr_erase(&dstr, i % dstr_length(dstr), 1);
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_is_empty(dstr));
	dstr_erase(&dstr, 0, 0);
	CHECK(dstr_is_empty(dstr));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	for (size_t i = 0; i < abc_len; i++) {
		dstr_erase(&dstr, i, 0);
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_equal_cstr(dstr, abc));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < a256_len; i++) {
		dstr_erase(&dstr, i, 0);
		CHECK(sanity_check(dstr));
	}
	CHECK(dstr_equal_cstr(dstr, a256));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("---aaa---");
	dstr_strip(&dstr, "-");
	CHECK(dstr_equal_cstr(dstr, "aaa"));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("---aaa---");
	dstr_lstrip(&dstr, "-");
	CHECK(dstr_equal_cstr(dstr, "aaa---"));
	CHECK(sanity_check(dstr));
	dstr_rstrip(&dstr, "-");
	CHECK(dstr_equal_cstr(dstr, "aaa"));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("---aaa---");
	dstr_rstrip(&dstr, "-");
	CHECK(dstr_equal_cstr(dstr, "---aaa"));
	CHECK(sanity_check(dstr));
	dstr_lstrip(&dstr, "-");
	CHECK(dstr_equal_cstr(dstr, "aaa"));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabacba");
	dstr_strip(&dstr, "ab");
	CHECK(dstr_equal_cstr(dstr, "cabac"));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "ca");
	CHECK(dstr_equal_cstr(dstr, "b"));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcdeffedcba");
	dstr_strip(&dstr, "bcdef");
	CHECK(dstr_equal_cstr(dstr, "abcdeffedcba"));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "");
	CHECK(dstr_equal_cstr(dstr, "abcdeffedcba"));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "ac");
	CHECK(dstr_equal_cstr(dstr, "bcdeffedcb"));
	CHECK(sanity_check(dstr));
	dstr_lstrip(&dstr, "efcb");
	CHECK(dstr_equal_cstr(dstr, "deffedcb"));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "bcdf");
	CHECK(dstr_equal_cstr(dstr, "effe"));
	CHECK(sanity_check(dstr));
	dstr_rstrip(&dstr, "ef");
	CHECK(dstr_equal_cstr(dstr, ""));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "");
	CHECK(dstr_equal_cstr(dstr, ""));
	CHECK(sanity_check(dstr));
	dstr_strip(&dstr, "abcdef");
	CHECK(dstr_equal_cstr(dstr, ""));
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	char *cstr = dstr_to_cstr(&dstr);
	CHECK(!dstr);
	CHECK(strcmp(cstr, abc) == 0);
	free(cstr);

	dstr = dstr_from_cstr(abc);
	cstr = dstr_to_cstr_copy(dstr);
	CHECK(strcmp(cstr, abc) == 0);
	free(cstr);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	cstr = dstr_to_cstr(&dstr);
	CHECK(!dstr);
	CHECK(strcmp(cstr, a256) == 0);
	free(cstr);

	dstr = dstr_from_cstr(a256);
	cstr = dstr_to_cstr_copy(dstr);
	CHECK(strcmp(cstr, a256) == 0);
	free(cstr);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	struct strview view = dstr_view(dstr);
	CHECK(strview_equal(view, strview_from_cstr(abc)));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	view = dstr_view(dstr);
	CHECK(strview_equal(view, strview_from_cstr(a256)));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	for (size_t i = 0; i < abc_len / 2; i++) {
		view = dstr_substring_view(dstr, i, abc_len - 2 * i);
		dstr2 = dstr_substring_copy(dstr, i, abc_len - 2 * i);
		CHECK(sanity_check(dstr2));
		CHECK(strview_equal(view,
				     strview_substring(strview_from_cstr(abc), i, abc_len - 2 * i)));
		CHECK(dstr_equal_view(dstr2, view));
		dstr_free(&dstr2);
	}
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < a256_len; i++) {
		view = dstr_substring_view(dstr, i, a256_len - 2 * i);
		dstr2 = dstr_substring_copy(dstr, i, a256_len - 2 * i);
		CHECK(sanity_check(dstr2));
		CHECK(strview_equal(view,
				     strview_substring(strview_from_cstr(a256), i, a256_len - 2 * i)));
		CHECK(dstr_equal_view(dstr2, view));
		dstr_free(&dstr2);
	}
	dstr_free(&dstr);

	for (size_t i = 0; i < abc_len / 2; i++) {
		dstr = dstr_from_cstr(abc);
		dstr2 = dstr_substring_copy(dstr, i, abc_len - 2 * i);
		dstr_substring(&dstr, i, abc_len - 2 * i);
		CHECK(sanity_check(dstr));
		CHECK(sanity_check(dstr2));
		CHECK(dstr_equal_view(dstr,
				       strview_substring(strview_from_cstr(abc), i, abc_len - 2 * i)));
		CHECK(dstr_equal_dstr(dstr, dstr2));
		dstr_free(&dstr2);
		dstr_free(&dstr);
	}

	for (size_t i = 0; i < a256_len; i++) {
		dstr = dstr_from_cstr(a256);
		dstr2 = dstr_substring_copy(dstr, i, a256_len - 2 * i);
		dstr_substring(&dstr, i, a256_len - 2 * i);
		CHECK(sanity_check(dstr));
		CHECK(sanity_check(dstr2));
		CHECK(dstr_equal_view(dstr,
				       strview_substring(strview_from_cstr(a256), i, a256_len - 2 * i)));
		CHECK(dstr_equal_dstr(dstr, dstr2));
		dstr_free(&dstr2);
		dstr_free(&dstr);
	}

	dstr = dstr_new();
	dstr2 = dstr_substring_copy(dstr, 0, 0);
	dstr_substring(&dstr, 0, 0);
	CHECK(dstr_equal_cstr(dstr, ""));
	CHECK(dstr_equal_dstr(dstr, dstr2));
	CHECK(sanity_check(dstr));
	CHECK(sanity_check(dstr2));
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	const char *str = "abc";
	int r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r == 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r == 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r > 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "abc";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r < 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "def";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r < 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("def");
	str = "abc";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r > 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abcd";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r < 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "ab";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r > 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abd";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r < 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abb";
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r > 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	str = abc;
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r == 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	str = a256;
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r == 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	str = a256;
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r < 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	str = abc;
	r = sign(dstr_compare_cstr(dstr, str));
	CHECK(r > 0);
	CHECK(sign(dstr_compare_view(dstr, strview_from_cstr(str))) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(sign(dstr_compare_dstr(dstr, dstr2)) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abc";
	r = dstr_equal_cstr(dstr, str);
	CHECK(r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "ab";
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abcd";
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abd";
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "";
	r = dstr_equal_cstr(dstr, str);
	CHECK(r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "";
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "abc";
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	str = abc;
	r = dstr_equal_cstr(dstr, str);
	CHECK(r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	str = a256;
	r = dstr_equal_cstr(dstr, str);
	CHECK(r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	str = a256;
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	str = abc;
	r = dstr_equal_cstr(dstr, str);
	CHECK(!r);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(str)) == r);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_equal_dstr(dstr, dstr2) == r);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abc";
	size_t s = 0;
	size_t p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "ab";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "a";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "c";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 2);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabc");
	str = "abc";
	s = 1;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 3);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 3;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 3);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 4;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 6);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 7;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "a";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "x";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abcd";
	s = 0;
	p = dstr_find_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_find_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_find_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abc";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "ab";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "a";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 3);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "c";
	s = 1;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "c";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 2);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabc");
	str = "abc";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 3);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabc");
	str = "abc";
	s = 2;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 3;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 3);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 6;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 6);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = 0;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcabcabc");
	str = "abc";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 6);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == 0);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	str = "a";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "x";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc");
	str = "abcd";
	s = DSTR_NPOS;
	p = dstr_rfind_cstr(dstr, str, s);
	CHECK(p == DSTR_NPOS);
	CHECK(dstr_rfind_view(dstr, strview_from_cstr(str), s) == p);
	dstr2 = dstr_from_cstr(str);
	CHECK(dstr_rfind_dstr(dstr, dstr2, s) == p);
	dstr_free(&dstr2);
	dstr_free(&dstr);

	const char *haystack = "abc";
	const char *needle = "abc";
	const char *replacement = "abc";
	size_t max = SIZE_MAX;
	const char *result = "abc";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr_t dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr_t dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "abc";
	replacement = "x";
	max = SIZE_MAX;
	result = "x";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "abc";
	replacement = a256;
	max = SIZE_MAX;
	result = a256;
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "b";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "axxxxxc";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "a";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "xxxxxbc";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "c";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "abxxxxx";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = SIZE_MAX;
	result = "aaaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 0;
	result = "aaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 1;
	result = "aaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 2;
	result = "aaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 3;
	result = "aaaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "";
	replacement = "";
	max = SIZE_MAX;
	result = "";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "a";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "x";
	replacement = "y";
	max = SIZE_MAX;
	result = "";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "x";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "axa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "xx";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "axaxa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "a";
	max = SIZE_MAX;
	result = "aaa";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "a";
	max = 1;
	result = "aabcabc";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "abcdef";
	max = SIZE_MAX;
	result = "abcdefabcdefabcdef";
	dstr = dstr_from_cstr(haystack);
	dstr_find_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_find_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_find_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "abc";
	replacement = "abc";
	max = SIZE_MAX;
	result = "abc";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "abc";
	replacement = "x";
	max = SIZE_MAX;
	result = "x";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "abc";
	replacement = a256;
	max = SIZE_MAX;
	result = a256;
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "b";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "axxxxxc";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "a";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "xxxxxbc";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abc";
	needle = "c";
	replacement = "xxxxx";
	max = SIZE_MAX;
	result = "abxxxxx";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = SIZE_MAX;
	result = "aaaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 0;
	result = "aaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 1;
	result = "aaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 2;
	result = "aaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "aaa";
	needle = "a";
	replacement = "aa";
	max = 3;
	result = "aaaaaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "";
	replacement = "";
	max = SIZE_MAX;
	result = "";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "a";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "";
	needle = "x";
	replacement = "y";
	max = SIZE_MAX;
	result = "";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "x";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "axa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "xx";
	needle = "";
	replacement = "a";
	max = SIZE_MAX;
	result = "axaxa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "a";
	max = SIZE_MAX;
	result = "aaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "a";
	max = 1;
	result = "abcabca";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "abcdef";
	max = SIZE_MAX;
	result = "abcdefabcdefabcdef";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	haystack = "abcabcabc";
	needle = "abc";
	replacement = "a";
	max = 2;
	result = "abcaa";
	dstr = dstr_from_cstr(haystack);
	dstr_rfind_replace_cstr(&dstr, needle, replacement, max);
	CHECK(dstr_equal_cstr(dstr, result));
	dstr_free(&dstr);
	dstr = dstr_from_view(strview_from_cstr(haystack));
	dstr_rfind_replace_view(&dstr, strview_from_cstr(needle), strview_from_cstr(replacement), max);
	CHECK(dstr_equal_view(dstr, strview_from_cstr(result)));
	dstr_free(&dstr);
	dstr = dstr_from_chars(haystack, strlen(haystack));
	dstr2 = dstr_from_cstr(needle);
	dstr3 = dstr_from_cstr(replacement);
	dstr_rfind_replace_dstr(&dstr, dstr2, dstr3, max);
	dstr4 = dstr_from_cstr(result);
	CHECK(dstr_equal_dstr(dstr, dstr4));
	dstr_free(&dstr2);
	dstr_free(&dstr3);
	dstr_free(&dstr4);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abcdefghij0123456789");
	CHECK(dstr_find_first_of(dstr, "", 0) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "a", 0) == 0);
	CHECK(dstr_find_first_of(dstr, "b", 0) == 1);
	CHECK(dstr_find_first_of(dstr, "c", 0) == 2);
	CHECK(dstr_find_first_of(dstr, "d", 0) == 3);
	CHECK(dstr_find_first_of(dstr, "e", 0) == 4);
	CHECK(dstr_find_first_of(dstr, "f", 0) == 5);
	CHECK(dstr_find_first_of(dstr, "g", 0) == 6);
	CHECK(dstr_find_first_of(dstr, "h", 0) == 7);
	CHECK(dstr_find_first_of(dstr, "i", 0) == 8);
	CHECK(dstr_find_first_of(dstr, "j", 0) == 9);
	CHECK(dstr_find_first_of(dstr, "0", 0) == 10);
	CHECK(dstr_find_first_of(dstr, "1", 0) == 11);
	CHECK(dstr_find_first_of(dstr, "2", 0) == 12);
	CHECK(dstr_find_first_of(dstr, "3", 0) == 13);
	CHECK(dstr_find_first_of(dstr, "4", 0) == 14);
	CHECK(dstr_find_first_of(dstr, "5", 0) == 15);
	CHECK(dstr_find_first_of(dstr, "6", 0) == 16);
	CHECK(dstr_find_first_of(dstr, "7", 0) == 17);
	CHECK(dstr_find_first_of(dstr, "8", 0) == 18);
	CHECK(dstr_find_first_of(dstr, "9", 0) == 19);
	CHECK(dstr_find_first_of(dstr, "a", 0) == 0);
	CHECK(dstr_find_first_of(dstr, "b", 1) == 1);
	CHECK(dstr_find_first_of(dstr, "c", 2) == 2);
	CHECK(dstr_find_first_of(dstr, "d", 3) == 3);
	CHECK(dstr_find_first_of(dstr, "e", 4) == 4);
	CHECK(dstr_find_first_of(dstr, "f", 5) == 5);
	CHECK(dstr_find_first_of(dstr, "g", 6) == 6);
	CHECK(dstr_find_first_of(dstr, "h", 7) == 7);
	CHECK(dstr_find_first_of(dstr, "i", 8) == 8);
	CHECK(dstr_find_first_of(dstr, "j", 9) == 9);
	CHECK(dstr_find_first_of(dstr, "0", 10) == 10);
	CHECK(dstr_find_first_of(dstr, "1", 11) == 11);
	CHECK(dstr_find_first_of(dstr, "2", 12) == 12);
	CHECK(dstr_find_first_of(dstr, "3", 13) == 13);
	CHECK(dstr_find_first_of(dstr, "4", 14) == 14);
	CHECK(dstr_find_first_of(dstr, "5", 15) == 15);
	CHECK(dstr_find_first_of(dstr, "6", 16) == 16);
	CHECK(dstr_find_first_of(dstr, "7", 17) == 17);
	CHECK(dstr_find_first_of(dstr, "8", 18) == 18);
	CHECK(dstr_find_first_of(dstr, "9", 19) == 19);
	CHECK(dstr_find_first_of(dstr, "a", 1) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "b", 2) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "c", 3) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "d", 4) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "e", 5) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "f", 6) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "g", 7) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "h", 8) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "i", 9) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "j", 10) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "0", 11) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "1", 12) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "2", 13) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "3", 14) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "4", 15) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "5", 16) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "6", 17) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "7", 18) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "8", 19) == DSTR_NPOS);
	CHECK(dstr_find_first_of(dstr, "9", 20) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "", DSTR_NPOS) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "a", DSTR_NPOS) == 0);
	CHECK(dstr_find_last_of(dstr, "b", DSTR_NPOS) == 1);
	CHECK(dstr_find_last_of(dstr, "c", DSTR_NPOS) == 2);
	CHECK(dstr_find_last_of(dstr, "d", DSTR_NPOS) == 3);
	CHECK(dstr_find_last_of(dstr, "e", DSTR_NPOS) == 4);
	CHECK(dstr_find_last_of(dstr, "f", DSTR_NPOS) == 5);
	CHECK(dstr_find_last_of(dstr, "g", DSTR_NPOS) == 6);
	CHECK(dstr_find_last_of(dstr, "h", DSTR_NPOS) == 7);
	CHECK(dstr_find_last_of(dstr, "i", DSTR_NPOS) == 8);
	CHECK(dstr_find_last_of(dstr, "j", DSTR_NPOS) == 9);
	CHECK(dstr_find_last_of(dstr, "0", DSTR_NPOS) == 10);
	CHECK(dstr_find_last_of(dstr, "1", DSTR_NPOS) == 11);
	CHECK(dstr_find_last_of(dstr, "2", DSTR_NPOS) == 12);
	CHECK(dstr_find_last_of(dstr, "3", DSTR_NPOS) == 13);
	CHECK(dstr_find_last_of(dstr, "4", DSTR_NPOS) == 14);
	CHECK(dstr_find_last_of(dstr, "5", DSTR_NPOS) == 15);
	CHECK(dstr_find_last_of(dstr, "6", DSTR_NPOS) == 16);
	CHECK(dstr_find_last_of(dstr, "7", DSTR_NPOS) == 17);
	CHECK(dstr_find_last_of(dstr, "8", DSTR_NPOS) == 18);
	CHECK(dstr_find_last_of(dstr, "9", DSTR_NPOS) == 19);
	CHECK(dstr_find_last_of(dstr, "a", 0) == 0);
	CHECK(dstr_find_last_of(dstr, "b", 1) == 1);
	CHECK(dstr_find_last_of(dstr, "c", 2) == 2);
	CHECK(dstr_find_last_of(dstr, "d", 3) == 3);
	CHECK(dstr_find_last_of(dstr, "e", 4) == 4);
	CHECK(dstr_find_last_of(dstr, "f", 5) == 5);
	CHECK(dstr_find_last_of(dstr, "g", 6) == 6);
	CHECK(dstr_find_last_of(dstr, "h", 7) == 7);
	CHECK(dstr_find_last_of(dstr, "i", 8) == 8);
	CHECK(dstr_find_last_of(dstr, "j", 9) == 9);
	CHECK(dstr_find_last_of(dstr, "0", 10) == 10);
	CHECK(dstr_find_last_of(dstr, "1", 11) == 11);
	CHECK(dstr_find_last_of(dstr, "2", 12) == 12);
	CHECK(dstr_find_last_of(dstr, "3", 13) == 13);
	CHECK(dstr_find_last_of(dstr, "4", 14) == 14);
	CHECK(dstr_find_last_of(dstr, "5", 15) == 15);
	CHECK(dstr_find_last_of(dstr, "6", 16) == 16);
	CHECK(dstr_find_last_of(dstr, "7", 17) == 17);
	CHECK(dstr_find_last_of(dstr, "8", 18) == 18);
	CHECK(dstr_find_last_of(dstr, "9", 19) == 19);
	CHECK(dstr_find_last_of(dstr, "a", 0) == 0);
	CHECK(dstr_find_last_of(dstr, "b", 0) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "c", 1) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "d", 2) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "e", 3) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "f", 4) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "g", 5) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "h", 6) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "i", 7) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "j", 8) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "0", 9) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "1", 10) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "2", 11) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "3", 12) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "4", 13) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "5", 14) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "6", 15) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "7", 16) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "8", 17) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "9", 18) == DSTR_NPOS);
	CHECK(dstr_find_first_not_of(dstr, "a", 0) == 1);
	CHECK(dstr_find_first_not_of(dstr, "a", 1) == 1);
	CHECK(dstr_find_first_not_of(dstr, "b", 0) == 0);
	CHECK(dstr_find_first_not_of(dstr, "b", 1) == 2);
	CHECK(dstr_find_first_not_of(dstr, "c", 0) == 0);
	CHECK(dstr_find_first_not_of(dstr, "c", 2) == 3);
	CHECK(dstr_find_last_not_of(dstr, "9", DSTR_NPOS) == 18);
	CHECK(dstr_find_last_not_of(dstr, "9", 19) == 18);
	CHECK(dstr_find_last_not_of(dstr, "8", DSTR_NPOS) == 19);
	CHECK(dstr_find_last_not_of(dstr, "8", 18) == 17);
	CHECK(dstr_find_last_not_of(dstr, "7", DSTR_NPOS) == 19);
	CHECK(dstr_find_last_not_of(dstr, "7", 17) == 16);
	CHECK(dstr_find_first_of(dstr, "abcdefghij", 0) == 0);
	CHECK(dstr_find_first_of(dstr, "0123456789", 0) == 10);
	CHECK(dstr_find_last_of(dstr, "abcdefghij", DSTR_NPOS) == 9);
	CHECK(dstr_find_last_of(dstr, "0123456789", DSTR_NPOS) == 19);
	CHECK(dstr_find_first_of(dstr, "abcdefghij", 5) == 5);
	CHECK(dstr_find_first_of(dstr, "0123456789", 15) == 15);
	CHECK(dstr_find_last_of(dstr, "abcdefghij", 5) == 5);
	CHECK(dstr_find_last_of(dstr, "0123456789", 15) == 15);
	CHECK(dstr_find_first_not_of(dstr, "abcdefghij", 0) == 10);
	CHECK(dstr_find_first_not_of(dstr, "0123456789", 0) == 0);
	CHECK(dstr_find_last_not_of(dstr, "abcdefghij", DSTR_NPOS) == 19);
	CHECK(dstr_find_last_not_of(dstr, "0123456789", DSTR_NPOS) == 9);
	CHECK(dstr_find_first_not_of(dstr, "abcdefghij", 15) == 15);
	CHECK(dstr_find_first_not_of(dstr, "0123456789", 5) == 5);
	CHECK(dstr_find_last_not_of(dstr, "abcdefghij", 15) == 15);
	CHECK(dstr_find_last_not_of(dstr, "0123456789", 5) == 5);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("abc123def456ghi789");
	CHECK(dstr_find_first_of(dstr, "abcdefghij", 0) == 0);
	CHECK(dstr_find_first_of(dstr, "abcdefghij", 3) == 6);
	CHECK(dstr_find_first_of(dstr, "abcdefghij", 8) == 8);
	CHECK(dstr_find_first_of(dstr, "0123456789", 0) == 3);
	CHECK(dstr_find_first_of(dstr, "0123456789", 6) == 9);
	CHECK(dstr_find_first_of(dstr, "0123456789", 11) == 11);
	CHECK(dstr_find_last_of(dstr, "0123456789", DSTR_NPOS) == 17);
	CHECK(dstr_find_last_of(dstr, "0123456789", 14) == 11);
	CHECK(dstr_find_last_of(dstr, "0123456789", 9) == 9);
	CHECK(dstr_find_last_of(dstr, "abcdefghij", DSTR_NPOS) == 14);
	CHECK(dstr_find_last_of(dstr, "abcdefghij", 11) == 8);
	CHECK(dstr_find_last_of(dstr, "abcdefghij", 6) == 6);
	CHECK(dstr_find_first_not_of(dstr, "abcdefghij", 0) == 3);
	CHECK(dstr_find_first_not_of(dstr, "abcdefghij", 5) == 5);
	CHECK(dstr_find_first_not_of(dstr, "abcdefghij", 6) == 9);
	CHECK(dstr_find_first_not_of(dstr, "0123456789", 0) == 0);
	CHECK(dstr_find_first_not_of(dstr, "0123456789", 2) == 2);
	CHECK(dstr_find_first_not_of(dstr, "0123456789", 3) == 6);
	CHECK(dstr_find_last_not_of(dstr, "abcdefghij", DSTR_NPOS) == 17);
	CHECK(dstr_find_last_not_of(dstr, "abcdefghij", 14) == 11);
	CHECK(dstr_find_last_not_of(dstr, "abcdefghij", 9) == 9);
	CHECK(dstr_find_last_not_of(dstr, "0123456789", DSTR_NPOS) == 14);
	CHECK(dstr_find_last_not_of(dstr, "0123456789", 11) == 8);
	CHECK(dstr_find_last_not_of(dstr, "0123456789", 6) == 6);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	CHECK(dstr_find_first_of(dstr, "abc123def456ghi789", 0) == DSTR_NPOS);
	CHECK(dstr_find_first_not_of(dstr, "abc123def456ghi789", 0) == DSTR_NPOS);
	CHECK(dstr_find_last_of(dstr, "abc123def456ghi789", DSTR_NPOS) == DSTR_NPOS);
	CHECK(dstr_find_last_not_of(dstr, "abc123def456ghi789", DSTR_NPOS) == DSTR_NPOS);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xxxxx");
	CHECK(dstr_find_first_of(dstr, "abc123def456ghi789", 0) == DSTR_NPOS);
	CHECK(dstr_find_first_not_of(dstr, "abc123def456ghi789", 0) == 0);
	CHECK(dstr_find_last_of(dstr, "abc123def456ghi789", DSTR_NPOS) == DSTR_NPOS);
	CHECK(dstr_find_last_not_of(dstr, "abc123def456ghi789", DSTR_NPOS) == 4);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = 0; i < abc_len; i++) {
		CHECK(dstr_find_first_of(dstr, a256, i) == i);
		CHECK(dstr_find_first_not_of(dstr, a256, i) == DSTR_NPOS);
	}
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	for (size_t i = abc_len - 1; i-- > 0;) {
		CHECK(dstr_find_last_of(dstr, a256, i) == i);
		CHECK(dstr_find_last_not_of(dstr, a256, i) == DSTR_NPOS);
	}
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr(abc)));
	CHECK(dstr_endswith_cstr(dstr, abc));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr(abc)));
	CHECK(dstr_startswith_cstr(dstr, ""));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr("")));
	CHECK(dstr_endswith_cstr(dstr, ""));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr("")));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	CHECK(dstr_startswith_cstr(dstr, a256));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr(a256)));
	CHECK(dstr_endswith_cstr(dstr, a256));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr(a256)));
	CHECK(dstr_startswith_cstr(dstr, ""));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr("")));
	CHECK(dstr_endswith_cstr(dstr, ""));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr("")));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	CHECK(!dstr_startswith_cstr(dstr, "a"));
	CHECK(!dstr_startswith_view(dstr, strview_from_cstr("a")));
	CHECK(!dstr_endswith_cstr(dstr, "a"));
	CHECK(!dstr_endswith_view(dstr, strview_from_cstr("a")));
	CHECK(dstr_startswith_cstr(dstr, ""));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr("")));
	CHECK(dstr_endswith_cstr(dstr, ""));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr("")));
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axb");
	CHECK(dstr_startswith_cstr(dstr, "a"));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr("a")));
	CHECK(dstr_endswith_cstr(dstr, "b"));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr("b")));
	CHECK(dstr_startswith_cstr(dstr, "ax"));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr("ax")));
	CHECK(dstr_endswith_cstr(dstr, "xb"));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr("xb")));
	CHECK(!dstr_startswith_cstr(dstr, "b"));
	CHECK(!dstr_startswith_view(dstr, strview_from_cstr("b")));
	CHECK(!dstr_endswith_cstr(dstr, "a"));
	CHECK(!dstr_endswith_view(dstr, strview_from_cstr("a")));
	CHECK(!dstr_startswith_cstr(dstr, "xb"));
	CHECK(!dstr_startswith_view(dstr, strview_from_cstr("xb")));
	CHECK(!dstr_endswith_cstr(dstr, "ax"));
	CHECK(!dstr_endswith_view(dstr, strview_from_cstr("ax")));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	dstr_append_cstr(&dstr, a256);
	CHECK(dstr_startswith_cstr(dstr, a256));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr(a256)));
	CHECK(dstr_endswith_cstr(dstr, a256));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr(a256)));
	dstr_free(&dstr);

	dstr = dstr_from_cstr(abc);
	dstr_append_char(&dstr, '-');
	dstr_append_cstr(&dstr, abc);
	CHECK(dstr_startswith_cstr(dstr, abc));
	CHECK(dstr_startswith_view(dstr, strview_from_cstr(abc)));
	CHECK(dstr_endswith_cstr(dstr, abc));
	CHECK(dstr_endswith_view(dstr, strview_from_cstr(abc)));
	CHECK(!dstr_startswith_cstr(dstr, "-"));
	CHECK(!dstr_startswith_view(dstr, strview_from_cstr("-")));
	CHECK(!dstr_endswith_cstr(dstr, "-"));
	CHECK(!dstr_endswith_view(dstr, strview_from_cstr("-")));
	dstr2 = dstr_substring_copy(dstr, abc_len, DSTR_NPOS);
	CHECK(dstr_startswith_cstr(dstr2, "-"));
	CHECK(dstr_startswith_view(dstr2, strview_from_cstr("-")));
	CHECK(!dstr_startswith_cstr(dstr2, abc));
	CHECK(!dstr_startswith_view(dstr2, strview_from_cstr(abc)));
	dstr_free(&dstr2);
	dstr2 = dstr_substring_copy(dstr, abc_len + 1, DSTR_NPOS);
	CHECK(dstr_startswith_cstr(dstr2, abc));
	CHECK(dstr_startswith_view(dstr2, strview_from_cstr(abc)));
	CHECK(!dstr_startswith_cstr(dstr2, "-"));
	CHECK(!dstr_startswith_view(dstr2, strview_from_cstr("-")));
	dstr_free(&dstr2);
	dstr2 = dstr_substring_copy(dstr, 0, abc_len + 1);
	CHECK(dstr_endswith_cstr(dstr2, "-"));
	CHECK(dstr_endswith_view(dstr2, strview_from_cstr("-")));
	CHECK(!dstr_endswith_cstr(dstr2, abc));
	CHECK(!dstr_endswith_view(dstr2, strview_from_cstr(abc)));
	dstr_free(&dstr2);
	dstr2 = dstr_substring_copy(dstr, 0, abc_len);
	CHECK(dstr_endswith_cstr(dstr2, abc));
	CHECK(dstr_endswith_view(dstr2, strview_from_cstr(abc)));
	CHECK(!dstr_endswith_cstr(dstr2, "-"));
	CHECK(!dstr_endswith_view(dstr2, strview_from_cstr("-")));
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr(a256);
	dstr2 = dstr_from_cstr(a256);
	CHECK(dstr_startswith_dstr(dstr, dstr2));
	CHECK(dstr_endswith_dstr(dstr, dstr2));
	dstr_free(&dstr2);
	dstr2 = dstr_from_cstr("***");
	CHECK(!dstr_startswith_dstr(dstr, dstr2));
	CHECK(!dstr_endswith_dstr(dstr, dstr2));
	dstr_free(&dstr2);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	char c = 'x';
	max = SIZE_MAX;
	size_t count = 1;
	struct dstr_list dstr_list = dstr_split(dstr, c, max);
	struct strview_list strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("x");
	c = 'x';
	max = SIZE_MAX;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	c = 'x';
	max = 0;
	count = 0;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("x");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_split(dstr, c, max);
	strview_list = dstr_split_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	c = 'x';
	max = SIZE_MAX;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("x");
	c = 'x';
	max = SIZE_MAX;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[2], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("");
	c = 'x';
	max = 0;
	count = 0;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("x");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xx");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axax");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("axaxa");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xaxa");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = 2;
	count = 2;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(dstr_equal_cstr(dstr_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_from_cstr("xax");
	c = 'x';
	max = 1;
	count = 1;
	dstr_list = dstr_rsplit(dstr, c, max);
	strview_list = dstr_rsplit_views(dstr, c, max);
	CHECK(dstr_list.count == count);
	CHECK(strview_list.count == count);
	CHECK(dstr_equal_cstr(dstr_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	dstr_list_free(&dstr_list);
	strview_list_free(&strview_list);
	dstr_free(&dstr);

	dstr = dstr_new();
	dstr_reserve(&dstr, UINT8_MAX + 1);
	CHECK(sanity_check(dstr));
	dstr_reserve(&dstr, UINT16_MAX + 1);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);
	dstr = dstr_new();
	dstr_reserve(&dstr, UINT16_MAX + 1);
	CHECK(sanity_check(dstr));
	dstr_free(&dstr);

	struct strview view2;
	view = strview_from_cstr(abc);
	view2 = strview_from_chars(abc, abc_len);
	CHECK(strview_equal_cstr(view, abc));
	CHECK(strview_equal_cstr(view2, abc));
	CHECK(strview_equal(view, view2));

	view = strview_from_cstr(a256);
	view2 = strview_from_chars(a256, a256_len);
	CHECK(strview_equal_cstr(view, a256));
	CHECK(strview_equal_cstr(view2, a256));
	CHECK(strview_equal(view, view2));

	view = strview_from_cstr(a256);
	cstr = strview_to_cstr(view);
	CHECK(strcmp(cstr, a256) == 0);
	free(cstr);

	view = strview_from_cstr("abcdef");
	CHECK(strview_equal_cstr(strview_substring(view, 0, 0), ""));
	CHECK(strview_equal_cstr(strview_substring(view, 0, 1), "a"));
	CHECK(strview_equal_cstr(strview_substring(view, 0, 3), "abc"));
	CHECK(strview_equal_cstr(strview_substring(view, 0, 6), "abcdef"));
	CHECK(strview_equal_cstr(strview_substring(view, 1, 5), "bcdef"));
	CHECK(strview_equal_cstr(strview_substring(view, 2, 4), "cdef"));
	CHECK(strview_equal_cstr(strview_substring(view, 2, 2), "cd"));
	CHECK(strview_equal_cstr(strview_substring(view, 5, 1), "f"));
	CHECK(strview_equal_cstr(strview_substring(view, 0, STRVIEW_NPOS), "abcdef"));
	view = strview_from_cstr("");
	CHECK(strview_equal_cstr(strview_substring(view, 0, 0), ""));
	CHECK(strview_equal_cstr(strview_substring(view, 0, STRVIEW_NPOS), ""));

	view = strview_from_cstr("abcdef");
	CHECK(strview_equal_cstr(strview_narrow(view, 0, 0), "abcdef"));
	CHECK(strview_equal_cstr(strview_narrow(view, 1, 0), "bcdef"));
	CHECK(strview_equal_cstr(strview_narrow(view, 3, 0), "def"));
	CHECK(strview_equal_cstr(strview_narrow(view, 0, 1), "abcde"));
	CHECK(strview_equal_cstr(strview_narrow(view, 0, 3), "abc"));
	CHECK(strview_equal_cstr(strview_narrow(view, 1, 1), "bcde"));
	CHECK(strview_equal_cstr(strview_narrow(view, 2, 2), "cd"));
	CHECK(strview_equal_cstr(strview_narrow(view, 3, 3), ""));

	view = strview_from_cstr("abc");
	str = "abc";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r == 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("");
	str = "";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r == 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r > 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("");
	str = "abc";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r < 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "def";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r < 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("def");
	str = "abc";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r > 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "abcd";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r < 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "ab";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r > 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "abd";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r < 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "abb";
	r = sign(strview_compare_cstr(view, str));
	CHECK(r > 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr(abc);
	str = abc;
	r = sign(strview_compare_cstr(view, str));
	CHECK(r == 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr(a256);
	str = a256;
	r = sign(strview_compare_cstr(view, str));
	CHECK(r == 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr(abc);
	str = a256;
	r = sign(strview_compare_cstr(view, str));
	CHECK(r < 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr(a256);
	str = abc;
	r = sign(strview_compare_cstr(view, str));
	CHECK(r > 0);
	CHECK(sign(strview_compare(view, strview_from_cstr(str))) == r);
	view2 = strview_from_cstr(str);
	CHECK(sign(strview_compare(view, view2)) == r);

	view = strview_from_cstr("abc");
	str = "abc";
	r = strview_equal_cstr(view, str);
	CHECK(r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("abc");
	str = "ab";
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("abc");
	str = "abcd";
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("abc");
	str = "abd";
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("");
	str = "";
	r = strview_equal_cstr(view, str);
	CHECK(r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("abc");
	str = "";
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("");
	str = "abc";
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr(abc);
	str = abc;
	r = strview_equal_cstr(view, str);
	CHECK(r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr(a256);
	str = a256;
	r = strview_equal_cstr(view, str);
	CHECK(r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr(abc);
	str = a256;
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr(a256);
	str = abc;
	r = strview_equal_cstr(view, str);
	CHECK(!r);
	CHECK(strview_equal(view, strview_from_cstr(str)) == r);
	view2 = strview_from_cstr(str);
	CHECK(strview_equal(view, view2) == r);

	view = strview_from_cstr("abc");
	str = "abc";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "ab";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "a";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "c";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 2);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abcabc");
	str = "abc";
	s = 1;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 3);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 3;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 3);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 4;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 6);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 7;
	p = strview_find_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("");
	str = "";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("");
	str = "a";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "x";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "abcd";
	s = 0;
	p = strview_find_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_find(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_find(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "abc";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "ab";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "a";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 3);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "c";
	s = 1;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "c";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 2);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabc");
	str = "abc";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 3);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabc");
	str = "abc";
	s = 2;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 3;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 3);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 6;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 6);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = 0;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcabcabc");
	str = "abc";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 6);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("");
	str = "";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == 0);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("");
	str = "a";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "x";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abc");
	str = "abcd";
	s = STRVIEW_NPOS;
	p = strview_rfind_cstr(view, str, s);
	CHECK(p == STRVIEW_NPOS);
	CHECK(strview_rfind(view, strview_from_cstr(str), s) == p);
	view2 = strview_from_cstr(str);
	CHECK(strview_rfind(view, view2, s) == p);

	view = strview_from_cstr("abcdefghij0123456789");
	CHECK(strview_find_first_of(view, "", 0) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "a", 0) == 0);
	CHECK(strview_find_first_of(view, "b", 0) == 1);
	CHECK(strview_find_first_of(view, "c", 0) == 2);
	CHECK(strview_find_first_of(view, "d", 0) == 3);
	CHECK(strview_find_first_of(view, "e", 0) == 4);
	CHECK(strview_find_first_of(view, "f", 0) == 5);
	CHECK(strview_find_first_of(view, "g", 0) == 6);
	CHECK(strview_find_first_of(view, "h", 0) == 7);
	CHECK(strview_find_first_of(view, "i", 0) == 8);
	CHECK(strview_find_first_of(view, "j", 0) == 9);
	CHECK(strview_find_first_of(view, "0", 0) == 10);
	CHECK(strview_find_first_of(view, "1", 0) == 11);
	CHECK(strview_find_first_of(view, "2", 0) == 12);
	CHECK(strview_find_first_of(view, "3", 0) == 13);
	CHECK(strview_find_first_of(view, "4", 0) == 14);
	CHECK(strview_find_first_of(view, "5", 0) == 15);
	CHECK(strview_find_first_of(view, "6", 0) == 16);
	CHECK(strview_find_first_of(view, "7", 0) == 17);
	CHECK(strview_find_first_of(view, "8", 0) == 18);
	CHECK(strview_find_first_of(view, "9", 0) == 19);
	CHECK(strview_find_first_of(view, "a", 0) == 0);
	CHECK(strview_find_first_of(view, "b", 1) == 1);
	CHECK(strview_find_first_of(view, "c", 2) == 2);
	CHECK(strview_find_first_of(view, "d", 3) == 3);
	CHECK(strview_find_first_of(view, "e", 4) == 4);
	CHECK(strview_find_first_of(view, "f", 5) == 5);
	CHECK(strview_find_first_of(view, "g", 6) == 6);
	CHECK(strview_find_first_of(view, "h", 7) == 7);
	CHECK(strview_find_first_of(view, "i", 8) == 8);
	CHECK(strview_find_first_of(view, "j", 9) == 9);
	CHECK(strview_find_first_of(view, "0", 10) == 10);
	CHECK(strview_find_first_of(view, "1", 11) == 11);
	CHECK(strview_find_first_of(view, "2", 12) == 12);
	CHECK(strview_find_first_of(view, "3", 13) == 13);
	CHECK(strview_find_first_of(view, "4", 14) == 14);
	CHECK(strview_find_first_of(view, "5", 15) == 15);
	CHECK(strview_find_first_of(view, "6", 16) == 16);
	CHECK(strview_find_first_of(view, "7", 17) == 17);
	CHECK(strview_find_first_of(view, "8", 18) == 18);
	CHECK(strview_find_first_of(view, "9", 19) == 19);
	CHECK(strview_find_first_of(view, "a", 1) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "b", 2) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "c", 3) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "d", 4) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "e", 5) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "f", 6) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "g", 7) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "h", 8) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "i", 9) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "j", 10) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "0", 11) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "1", 12) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "2", 13) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "3", 14) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "4", 15) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "5", 16) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "6", 17) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "7", 18) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "8", 19) == STRVIEW_NPOS);
	CHECK(strview_find_first_of(view, "9", 20) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "", STRVIEW_NPOS) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "a", STRVIEW_NPOS) == 0);
	CHECK(strview_find_last_of(view, "b", STRVIEW_NPOS) == 1);
	CHECK(strview_find_last_of(view, "c", STRVIEW_NPOS) == 2);
	CHECK(strview_find_last_of(view, "d", STRVIEW_NPOS) == 3);
	CHECK(strview_find_last_of(view, "e", STRVIEW_NPOS) == 4);
	CHECK(strview_find_last_of(view, "f", STRVIEW_NPOS) == 5);
	CHECK(strview_find_last_of(view, "g", STRVIEW_NPOS) == 6);
	CHECK(strview_find_last_of(view, "h", STRVIEW_NPOS) == 7);
	CHECK(strview_find_last_of(view, "i", STRVIEW_NPOS) == 8);
	CHECK(strview_find_last_of(view, "j", STRVIEW_NPOS) == 9);
	CHECK(strview_find_last_of(view, "0", STRVIEW_NPOS) == 10);
	CHECK(strview_find_last_of(view, "1", STRVIEW_NPOS) == 11);
	CHECK(strview_find_last_of(view, "2", STRVIEW_NPOS) == 12);
	CHECK(strview_find_last_of(view, "3", STRVIEW_NPOS) == 13);
	CHECK(strview_find_last_of(view, "4", STRVIEW_NPOS) == 14);
	CHECK(strview_find_last_of(view, "5", STRVIEW_NPOS) == 15);
	CHECK(strview_find_last_of(view, "6", STRVIEW_NPOS) == 16);
	CHECK(strview_find_last_of(view, "7", STRVIEW_NPOS) == 17);
	CHECK(strview_find_last_of(view, "8", STRVIEW_NPOS) == 18);
	CHECK(strview_find_last_of(view, "9", STRVIEW_NPOS) == 19);
	CHECK(strview_find_last_of(view, "a", 0) == 0);
	CHECK(strview_find_last_of(view, "b", 1) == 1);
	CHECK(strview_find_last_of(view, "c", 2) == 2);
	CHECK(strview_find_last_of(view, "d", 3) == 3);
	CHECK(strview_find_last_of(view, "e", 4) == 4);
	CHECK(strview_find_last_of(view, "f", 5) == 5);
	CHECK(strview_find_last_of(view, "g", 6) == 6);
	CHECK(strview_find_last_of(view, "h", 7) == 7);
	CHECK(strview_find_last_of(view, "i", 8) == 8);
	CHECK(strview_find_last_of(view, "j", 9) == 9);
	CHECK(strview_find_last_of(view, "0", 10) == 10);
	CHECK(strview_find_last_of(view, "1", 11) == 11);
	CHECK(strview_find_last_of(view, "2", 12) == 12);
	CHECK(strview_find_last_of(view, "3", 13) == 13);
	CHECK(strview_find_last_of(view, "4", 14) == 14);
	CHECK(strview_find_last_of(view, "5", 15) == 15);
	CHECK(strview_find_last_of(view, "6", 16) == 16);
	CHECK(strview_find_last_of(view, "7", 17) == 17);
	CHECK(strview_find_last_of(view, "8", 18) == 18);
	CHECK(strview_find_last_of(view, "9", 19) == 19);
	CHECK(strview_find_last_of(view, "a", 0) == 0);
	CHECK(strview_find_last_of(view, "b", 0) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "c", 1) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "d", 2) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "e", 3) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "f", 4) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "g", 5) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "h", 6) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "i", 7) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "j", 8) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "0", 9) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "1", 10) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "2", 11) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "3", 12) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "4", 13) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "5", 14) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "6", 15) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "7", 16) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "8", 17) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "9", 18) == STRVIEW_NPOS);
	CHECK(strview_find_first_not_of(view, "a", 0) == 1);
	CHECK(strview_find_first_not_of(view, "a", 1) == 1);
	CHECK(strview_find_first_not_of(view, "b", 0) == 0);
	CHECK(strview_find_first_not_of(view, "b", 1) == 2);
	CHECK(strview_find_first_not_of(view, "c", 0) == 0);
	CHECK(strview_find_first_not_of(view, "c", 2) == 3);
	CHECK(strview_find_last_not_of(view, "9", STRVIEW_NPOS) == 18);
	CHECK(strview_find_last_not_of(view, "9", 19) == 18);
	CHECK(strview_find_last_not_of(view, "8", STRVIEW_NPOS) == 19);
	CHECK(strview_find_last_not_of(view, "8", 18) == 17);
	CHECK(strview_find_last_not_of(view, "7", STRVIEW_NPOS) == 19);
	CHECK(strview_find_last_not_of(view, "7", 17) == 16);
	CHECK(strview_find_first_of(view, "abcdefghij", 0) == 0);
	CHECK(strview_find_first_of(view, "0123456789", 0) == 10);
	CHECK(strview_find_last_of(view, "abcdefghij", STRVIEW_NPOS) == 9);
	CHECK(strview_find_last_of(view, "0123456789", STRVIEW_NPOS) == 19);
	CHECK(strview_find_first_of(view, "abcdefghij", 5) == 5);
	CHECK(strview_find_first_of(view, "0123456789", 15) == 15);
	CHECK(strview_find_last_of(view, "abcdefghij", 5) == 5);
	CHECK(strview_find_last_of(view, "0123456789", 15) == 15);
	CHECK(strview_find_first_not_of(view, "abcdefghij", 0) == 10);
	CHECK(strview_find_first_not_of(view, "0123456789", 0) == 0);
	CHECK(strview_find_last_not_of(view, "abcdefghij", STRVIEW_NPOS) == 19);
	CHECK(strview_find_last_not_of(view, "0123456789", STRVIEW_NPOS) == 9);
	CHECK(strview_find_first_not_of(view, "abcdefghij", 15) == 15);
	CHECK(strview_find_first_not_of(view, "0123456789", 5) == 5);
	CHECK(strview_find_last_not_of(view, "abcdefghij", 15) == 15);
	CHECK(strview_find_last_not_of(view, "0123456789", 5) == 5);

	view = strview_from_cstr("abc123def456ghi789");
	CHECK(strview_find_first_of(view, "abcdefghij", 0) == 0);
	CHECK(strview_find_first_of(view, "abcdefghij", 3) == 6);
	CHECK(strview_find_first_of(view, "abcdefghij", 8) == 8);
	CHECK(strview_find_first_of(view, "0123456789", 0) == 3);
	CHECK(strview_find_first_of(view, "0123456789", 6) == 9);
	CHECK(strview_find_first_of(view, "0123456789", 11) == 11);
	CHECK(strview_find_last_of(view, "0123456789", STRVIEW_NPOS) == 17);
	CHECK(strview_find_last_of(view, "0123456789", 14) == 11);
	CHECK(strview_find_last_of(view, "0123456789", 9) == 9);
	CHECK(strview_find_last_of(view, "abcdefghij", STRVIEW_NPOS) == 14);
	CHECK(strview_find_last_of(view, "abcdefghij", 11) == 8);
	CHECK(strview_find_last_of(view, "abcdefghij", 6) == 6);
	CHECK(strview_find_first_not_of(view, "abcdefghij", 0) == 3);
	CHECK(strview_find_first_not_of(view, "abcdefghij", 5) == 5);
	CHECK(strview_find_first_not_of(view, "abcdefghij", 6) == 9);
	CHECK(strview_find_first_not_of(view, "0123456789", 0) == 0);
	CHECK(strview_find_first_not_of(view, "0123456789", 2) == 2);
	CHECK(strview_find_first_not_of(view, "0123456789", 3) == 6);
	CHECK(strview_find_last_not_of(view, "abcdefghij", STRVIEW_NPOS) == 17);
	CHECK(strview_find_last_not_of(view, "abcdefghij", 14) == 11);
	CHECK(strview_find_last_not_of(view, "abcdefghij", 9) == 9);
	CHECK(strview_find_last_not_of(view, "0123456789", STRVIEW_NPOS) == 14);
	CHECK(strview_find_last_not_of(view, "0123456789", 11) == 8);
	CHECK(strview_find_last_not_of(view, "0123456789", 6) == 6);

	view = strview_from_cstr("");
	CHECK(strview_find_first_of(view, "abc123def456ghi789", 0) == STRVIEW_NPOS);
	CHECK(strview_find_first_not_of(view, "abc123def456ghi789", 0) == STRVIEW_NPOS);
	CHECK(strview_find_last_of(view, "abc123def456ghi789", STRVIEW_NPOS) == STRVIEW_NPOS);
	CHECK(strview_find_last_not_of(view, "abc123def456ghi789", STRVIEW_NPOS) == STRVIEW_NPOS);

	view = strview_from_cstr("xxxxx");
	CHECK(strview_find_first_of(view, "abc123def456ghi789", 0) == STRVIEW_NPOS);
	CHECK(strview_find_first_not_of(view, "abc123def456ghi789", 0) == 0);
	CHECK(strview_find_last_of(view, "abc123def456ghi789", STRVIEW_NPOS) == STRVIEW_NPOS);
	CHECK(strview_find_last_not_of(view, "abc123def456ghi789", STRVIEW_NPOS) == 4);

	view = strview_from_cstr(a256);
	for (size_t i = 0; i < abc_len; i++) {
		CHECK(strview_find_first_of(view, a256, i) == i);
		CHECK(strview_find_first_not_of(view, a256, i) == STRVIEW_NPOS);
	}

	view = strview_from_cstr(a256);
	for (size_t i = abc_len - 1; i-- > 0;) {
		CHECK(strview_find_last_of(view, a256, i) == i);
		CHECK(strview_find_last_not_of(view, a256, i) == STRVIEW_NPOS);
	}

	view = strview_from_cstr("---aaa---");
	view = strview_strip(view, "-");
	CHECK(strview_equal_cstr(view, "aaa"));

	view = strview_from_cstr("---aaa---");
	view = strview_lstrip(view, "-");
	CHECK(strview_equal_cstr(view, "aaa---"));
	view = strview_rstrip(view, "-");
	CHECK(strview_equal_cstr(view, "aaa"));

	view = strview_from_cstr("---aaa---");
	view = strview_rstrip(view, "-");
	CHECK(strview_equal_cstr(view, "---aaa"));
	view = strview_lstrip(view, "-");
	CHECK(strview_equal_cstr(view, "aaa"));

	view = strview_from_cstr("abcabacba");
	view = strview_strip(view, "ab");
	CHECK(strview_equal_cstr(view, "cabac"));
	view = strview_strip(view, "ca");
	CHECK(strview_equal_cstr(view, "b"));

	view = strview_from_cstr("abcdeffedcba");
	view = strview_strip(view, "bcdef");
	CHECK(strview_equal_cstr(view, "abcdeffedcba"));
	view = strview_strip(view, "");
	CHECK(strview_equal_cstr(view, "abcdeffedcba"));
	view = strview_strip(view, "ac");
	CHECK(strview_equal_cstr(view, "bcdeffedcb"));
	view = strview_lstrip(view, "efcb");
	CHECK(strview_equal_cstr(view, "deffedcb"));
	view = strview_strip(view, "bcdf");
	CHECK(strview_equal_cstr(view, "effe"));
	view = strview_rstrip(view, "ef");
	CHECK(strview_equal_cstr(view, ""));
	view = strview_strip(view, "");
	CHECK(strview_equal_cstr(view, ""));
	view = strview_strip(view, "abcdef");
	CHECK(strview_equal_cstr(view, ""));

	view = strview_from_cstr(abc);
	CHECK(strview_startswith_cstr(view, abc));
	CHECK(strview_startswith(view, strview_from_cstr(abc)));
	CHECK(strview_endswith_cstr(view, abc));
	CHECK(strview_endswith(view, strview_from_cstr(abc)));
	CHECK(strview_startswith_cstr(view, ""));
	CHECK(strview_startswith(view, strview_from_cstr("")));
	CHECK(strview_endswith_cstr(view, ""));
	CHECK(strview_endswith(view, strview_from_cstr("")));

	view = strview_from_cstr(a256);
	CHECK(strview_startswith_cstr(view, a256));
	CHECK(strview_startswith(view, strview_from_cstr(a256)));
	CHECK(strview_endswith_cstr(view, a256));
	CHECK(strview_endswith(view, strview_from_cstr(a256)));
	CHECK(strview_startswith_cstr(view, ""));
	CHECK(strview_startswith(view, strview_from_cstr("")));
	CHECK(strview_endswith_cstr(view, ""));
	CHECK(strview_endswith(view, strview_from_cstr("")));

	view = strview_from_cstr("");
	CHECK(!strview_startswith_cstr(view, "a"));
	CHECK(!strview_startswith(view, strview_from_cstr("a")));
	CHECK(!strview_endswith_cstr(view, "a"));
	CHECK(!strview_endswith(view, strview_from_cstr("a")));
	CHECK(strview_startswith_cstr(view, ""));
	CHECK(strview_startswith(view, strview_from_cstr("")));
	CHECK(strview_endswith_cstr(view, ""));
	CHECK(strview_endswith(view, strview_from_cstr("")));

	view = strview_from_cstr("axb");
	CHECK(strview_startswith_cstr(view, "a"));
	CHECK(strview_startswith(view, strview_from_cstr("a")));
	CHECK(strview_endswith_cstr(view, "b"));
	CHECK(strview_endswith(view, strview_from_cstr("b")));
	CHECK(strview_startswith_cstr(view, "ax"));
	CHECK(strview_startswith(view, strview_from_cstr("ax")));
	CHECK(strview_endswith_cstr(view, "xb"));
	CHECK(strview_endswith(view, strview_from_cstr("xb")));
	CHECK(!strview_startswith_cstr(view, "b"));
	CHECK(!strview_startswith(view, strview_from_cstr("b")));
	CHECK(!strview_endswith_cstr(view, "a"));
	CHECK(!strview_endswith(view, strview_from_cstr("a")));
	CHECK(!strview_startswith_cstr(view, "xb"));
	CHECK(!strview_startswith(view, strview_from_cstr("xb")));
	CHECK(!strview_endswith_cstr(view, "ax"));
	CHECK(!strview_endswith(view, strview_from_cstr("ax")));

	view = strview_from_chars(abc, abc_len - 1);
	CHECK(!strview_startswith_cstr(view, abc));
	CHECK(!strview_startswith(view, strview_from_cstr(abc)));

	dstr = dstr_from_fmt("%s%s", a256, a256);
	view = dstr_view(dstr);
	CHECK(strview_startswith_cstr(view, a256));
	CHECK(strview_startswith(view, strview_from_cstr(a256)));
	CHECK(strview_endswith_cstr(view, a256));
	CHECK(strview_endswith(view, strview_from_cstr(a256)));
	dstr_free(&dstr);

	dstr = dstr_from_fmt("%s-%s", abc, abc);
	view = dstr_view(dstr);
	CHECK(strview_startswith_cstr(view, abc));
	CHECK(strview_startswith(view, strview_from_cstr(abc)));
	CHECK(strview_endswith_cstr(view, abc));
	CHECK(strview_endswith(view, strview_from_cstr(abc)));
	CHECK(!strview_startswith_cstr(view, "-"));
	CHECK(!strview_startswith(view, strview_from_cstr("-")));
	CHECK(!strview_endswith_cstr(view, "-"));
	CHECK(!strview_endswith(view, strview_from_cstr("-")));
	view2 = strview_substring(view, abc_len, STRVIEW_NPOS);
	CHECK(strview_startswith_cstr(view2, "-"));
	CHECK(strview_startswith(view2, strview_from_cstr("-")));
	CHECK(!strview_startswith_cstr(view2, abc));
	CHECK(!strview_startswith(view2, strview_from_cstr(abc)));
	view2 = strview_substring(view, abc_len + 1, STRVIEW_NPOS);
	CHECK(strview_startswith_cstr(view2, abc));
	CHECK(strview_startswith(view2, strview_from_cstr(abc)));
	CHECK(!strview_startswith_cstr(view2, "-"));
	CHECK(!strview_startswith(view2, strview_from_cstr("-")));
	view2 = strview_substring(view, 0, abc_len + 1);
	CHECK(strview_endswith_cstr(view2, "-"));
	CHECK(strview_endswith(view2, strview_from_cstr("-")));
	CHECK(!strview_endswith_cstr(view2, abc));
	CHECK(!strview_endswith(view2, strview_from_cstr(abc)));
	view2 = strview_substring(view, 0, abc_len);
	CHECK(strview_endswith_cstr(view2, abc));
	CHECK(strview_endswith(view2, strview_from_cstr(abc)));
	CHECK(!strview_endswith_cstr(view2, "-"));
	CHECK(!strview_endswith(view2, strview_from_cstr("-")));
	dstr_free(&dstr);

	view = strview_from_cstr(a256);
	view2 = strview_from_cstr(a256);
	CHECK(strview_startswith(view, view2));
	CHECK(strview_endswith(view, view2));
	view2 = strview_from_cstr("***");
	CHECK(!strview_startswith(view, view2));
	CHECK(!strview_endswith(view, view2));

	view = strview_from_cstr("");
	c = 'x';
	max = SIZE_MAX;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("x");
	c = 'x';
	max = SIZE_MAX;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("");
	c = 'x';
	max = 0;
	count = 0;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	strview_list_free(&strview_list);

	view = strview_from_cstr("x");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_split(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("");
	c = 'x';
	max = SIZE_MAX;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("x");
	c = 'x';
	max = SIZE_MAX;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = SIZE_MAX;
	count = 3;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[2], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("");
	c = 'x';
	max = 0;
	count = 0;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	strview_list_free(&strview_list);

	view = strview_from_cstr("x");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xx");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axax");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("axaxa");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xaxa");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = 2;
	count = 2;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	CHECK(strview_equal_cstr(strview_list.strings[1], "a"));
	strview_list_free(&strview_list);

	view = strview_from_cstr("xax");
	c = 'x';
	max = 1;
	count = 1;
	strview_list = strview_rsplit(view, c, max);
	CHECK(strview_list.count == count);
	CHECK(strview_equal_cstr(strview_list.strings[0], ""));
	strview_list_free(&strview_list);

	return true;
}

#if defined(_FORTIFY_SOURCE) && (defined(HAVE_BUILTIN_DYNAMIC_OBJECT_SIZE) || defined(HAVE_BUILTIN_OBJECT_SIZE))

NEGATIVE_SIMPLE_TEST(fortify_from_chars)
{
	char chars[16] = {0};
	dstr_t dstr = dstr_from_chars(chars, sizeof(chars) + 1);
	dstr_free(&dstr);
	return true;
}

NEGATIVE_SIMPLE_TEST(fortify_append_chars)
{
	dstr_t dstr = dstr_new();
	char chars[16] = {0};
	dstr_append_chars(&dstr, chars, sizeof(chars) + 1);
	return true;
}

NEGATIVE_SIMPLE_TEST(fortify_insert_chars)
{
	dstr_t dstr = dstr_new();
	char chars[16] = {0};
	dstr_insert_chars(&dstr, 0, chars, sizeof(chars) + 1);
	return true;
}

NEGATIVE_SIMPLE_TEST(fortify_replace_chars)
{
	dstr_t dstr = dstr_new();
	char chars[16] = {0};
	dstr_replace_chars(&dstr, 0, 0, chars, sizeof(chars) + 1);
	return true;
}

NEGATIVE_SIMPLE_TEST(fortify_strview_from_chars)
{
	char chars[16] = {0};
	strview_from_chars(chars, sizeof(chars) + 1);
	return true;
}

#endif
